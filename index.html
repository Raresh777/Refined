<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leads Summary</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
      text-align: center;
    }
    
    h1 {
      color: #333;
    }
    
    input[type="file"], select, button {
      padding: 10px;
      margin: 10px;
      font-size: 16px;
    }
    
    #results {
      margin-top: 20px;
      padding: 10px;
      background-color: #fff;
      border-radius: 8px;
      display: inline-block;
      text-align: left;
    }
    
    .result-section {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

  <h1>Leads Summary by Date</h1>
  <input type="file" id="csvFileInput" accept=".csv" /><br>
  <label for="dateSelector">Select Date:</label>
  <select id="dateSelector"></select><br>
  <button onclick="processLeads()">Show Leads Summary</button>

  <div id="results" style="display:none;">
    <h2>Results for <span id="selectedDate"></span></h2>
    
    <div class="result-section">
      <h3>Total Leads: <span id="totalLeads"></span></h3>
    </div>

    <div class="result-section">
      <h3>Leads by Location</h3>
      <ul id="locationBreakdown"></ul>
    </div>

    <div class="result-section">
      <h3>Leads by First Language</h3>
      <ul id="languageBreakdown"></ul>
    </div>
  </div>

  <script>
    let leadsData = [];
    let dateOptions = new Set();

    function loadCSV(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      
      reader.onload = function (e) {
        const text = e.target.result;
        const lines = text.split('\n');
        const headers = lines[0].split(',');

        // Indices for the columns we need
        const dateIdx = headers.indexOf('Submission date');
        const emailIdx = headers.indexOf('Email');
        const phoneIdx = headers.indexOf('Phone Number');
        const locationIdx = headers.indexOf('Location');
        const languageIdx = headers.indexOf('Languages');

        leadsData = lines.slice(1).map(line => {
          const fields = line.split(',');
          return {
            date: fields[dateIdx],
            email: fields[emailIdx],
            phone: fields[phoneIdx],
            location: fields[locationIdx],
            language: fields[languageIdx].split(',')[0] // Extract first language
          };
        });

        // Populate date selector with unique dates
        leadsData.forEach(lead => dateOptions.add(lead.date));
        populateDateSelector();
      };
      
      reader.readAsText(file);
    }

    function populateDateSelector() {
      const dateSelector = document.getElementById('dateSelector');
      dateSelector.innerHTML = ''; // Clear the options

      dateOptions.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.text = date;
        dateSelector.appendChild(option);
      });
    }

    function processLeads() {
      const selectedDate = document.getElementById('dateSelector').value;
      const resultsDiv = document.getElementById('results');
      document.getElementById('selectedDate').textContent = selectedDate;

      // Filter leads by selected date and ensure uniqueness using email or phone number
      const leadsForSelectedDate = leadsData.filter(
        (lead, index, self) => 
          lead.date === selectedDate &&
          index === self.findIndex(l => l.email === lead.email || l.phone === lead.phone)
      );

      // Count total leads
      document.getElementById('totalLeads').textContent = leadsForSelectedDate.length;

      // Count leads by location
      const locationCount = {};
      leadsForSelectedDate.forEach(lead => {
        locationCount[lead.location] = (locationCount[lead.location] || 0) + 1;
      });

      const locationBreakdown = document.getElementById('locationBreakdown');
      locationBreakdown.innerHTML = ''; // Clear previous results
      for (const [location, count] of Object.entries(locationCount)) {
        const listItem = document.createElement('li');
        listItem.textContent = `${location}: ${count}`;
        locationBreakdown.appendChild(listItem);
      }

      // Count leads by first language
      const languageCount = {};
      leadsForSelectedDate.forEach(lead => {
        languageCount[lead.language] = (languageCount[lead.language] || 0) + 1;
      });

      const languageBreakdown = document.getElementById('languageBreakdown');
      languageBreakdown.innerHTML = ''; // Clear previous results
      for (const [language, count] of Object.entries(languageCount)) {
        const listItem = document.createElement('li');
        listItem.textContent = `${language}: ${count}`;
        languageBreakdown.appendChild(listItem);
      }

      resultsDiv.style.display = 'block';
    }

    document.getElementById('csvFileInput').addEventListener('change', loadCSV);
  </script>

</body>
</html>
